#!/usr/bin/env node

var docopt = require('docopt').docopt;
var fs = require('fs');

var doc = 'Usage: dg GISTID...' +
'\n' +
'\nOptions:' +
'\n  -h --help     Show this screen.' +
'\n  -v --version  Output version.';
var cli = docopt(doc, {help: true, version: '0.2.0'});
// return console.log(cli);

require('chainy').create().require('set map feed each')
	.set(cli['GISTID']) // array

	.map(function (id, complete) {
		this.create()
			.set('https://api.github.com/gists/' + id)
			.feed()
			.done(complete)
	}) // array of objects with Gist info now

	.map(function (gistObject, complete) {
		this.create()
			.set(gistObject.files)
			.done(complete)
	}) // now an array of Gist objects with file objects inside

	.each(function (itemValue, itemIndex, complete) { // iterate over array with objects
		this.create()
			.set(itemValue) // object
			.each(function (itemValue1, itemIndex1, complete1) { // iterate over objects with files
				console.log(itemValue1['filename']);
				fs.writeFile('./'+itemValue1['filename'], itemValue1['content'], function (err) {
					if (err) return console.log(err);
				});
				complete1()
			})
			.done(complete)
	}) // write da stuff

	.done(function (err, result) {
		if (err) return console.log(err.stack || err);
		else return;
	})

